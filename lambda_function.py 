# lambda_handler.py
from aws_lambda_powertools import Logger
from flask import Flask, jsonify, Request
import yaml
import awsgi


logger = Logger()

app = Flask(__name__)

@app.route('/api/resources', methods=['GET'])
def get_resources():
    try:
        with open('data/ebbcarbon.yaml', 'r') as file:
            resources = yaml.safe_load(file)
        return jsonify(resources), 200
    except FileNotFoundError:
        return "Resource file not found", 404
    except Exception as e:
        logger.exception("An error occurred: %s", e)
        return str(e), 500

def handler(event: dict, context):
    # Extract the HTTP method and path from the event
    http_method = event['requestContext']['http']['method']
    path = event['requestContext']['http']['path']
    
    # Create a request object for Flask
    request = Request({
        'method': http_method,
        'path': path,
        'query_string': event['queryStringParameters'] or '',
        'headers': event['headers'] or {},
        'body': event['body'] or ''
    })
    
    # Pass the request to Flask app
    response = app.full_dispatch_request(request)
    
    # Extract response data
    status_code = response.status_code
    headers = dict(response.headers)
    body = response.get_data()
    
    # Return API Gateway compatible response
    return {
        'statusCode': status_code,
        'headers': headers,
        'body': body.decode('utf-8')
    }
